<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kali Web Terminal</title>
    
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" href="/icon.png">
    <link rel="apple-touch-icon" href="/icon.png">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
    <style>
        body { 
            margin: 0; 
            background: #000; 
            height: 100vh; 
            overflow: hidden; 
            touch-action: none; 
        }
        
        #terminal { width: 100%; height: 100%; }

        /* Floating Buttons Style */
        .float-btn {
            position: fixed;
            width: 35px;
            height: 35px;
            background: rgba(0, 0, 0, 0.6); 
            color: #00ff00;
            border: 1px solid #00ff00;
            border-radius: 50%;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            user-select: none;
            backdrop-filter: blur(4px);
            box-shadow: 0 0 5px rgba(0, 255, 0, 0.3);
        }

        .float-btn:active { background: rgba(0, 255, 0, 0.4); color: #000; }

        /* --- RIGHT SIDE (Zoom In & Copy) --- */
        #btn-plus { right: 15px; bottom: 20px; }
        #btn-copy { right: 15px; bottom: 70px; } /* Above Plus */

        /* --- LEFT SIDE (Zoom Out & Paste) --- */
        #btn-minus { left: 15px; bottom: 20px; }
        #btn-paste { left: 15px; bottom: 70px; } /* Above Minus */

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 5px;
            padding: 10px;
            position: fixed;
            z-index: 2000;
            left: 50%;
            top: 20px; /* Show at top now */
            transform: translateX(-50%);
            font-size: 14px;
            border: 1px solid #00ff00;
            font-family: monospace;
        }

        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {top: 0; opacity: 0;} to {top: 20px; opacity: 1;} }
        @keyframes fadeout { from {top: 20px; opacity: 1;} to {top: 0; opacity: 0;} }
    </style>
</head>
<body>

    <div id="btn-minus" class="float-btn" onclick="changeFontSize(-2)">âˆ’</div>
    <div id="btn-paste" class="float-btn" onclick="pasteText()">ðŸ“‹</div> <div id="btn-plus" class="float-btn" onclick="changeFontSize(2)">+</div>
    <div id="btn-copy" class="float-btn" onclick="copyAll()">ðŸ“‘</div> <div id="terminal"></div>
    <div id="toast">âœ… Action Successful</div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links/lib/xterm-addon-web-links.js"></script>

    <script>
        const socket = io();
        let currentFontSize = 14;

        const term = new Terminal({
            cursorBlink: true,
            fontSize: currentFontSize,
            fontFamily: '"Fira Code", monospace',
            theme: { background: '#000000', foreground: '#00ff00' },
            allowTransparency: true
        });

        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(document.getElementById('terminal'));
        fitAddon.fit();

        // 1. ZOOM LOGIC
        function changeFontSize(amount) {
            currentFontSize += amount;
            if (currentFontSize < 6) currentFontSize = 6;
            if (currentFontSize > 40) currentFontSize = 40;
            term.options.fontSize = currentFontSize;
            fitAddon.fit();
            socket.emit('resize', { cols: term.cols, rows: term.rows });
        }

        // 2. COPY LOGIC (Right Top Button)
        function copyAll() {
            term.selectAll();
            const text = term.getSelection();
            navigator.clipboard.writeText(text).then(() => {
                term.clearSelection();
                showToast("âœ… All Text Copied!");
            }).catch(err => showToast("âŒ Copy Failed"));
        }

        // 3. PASTE LOGIC (Left Top Button)
        async function pasteText() {
            try {
                // Browser will ask for permission first time
                const text = await navigator.clipboard.readText();
                if (text) {
                    socket.emit('input', text); // Send directly to server
                    showToast("âœ… Text Pasted!");
                }
            } catch (err) {
                console.error(err);
                showToast("âš ï¸ Permission Denied / Empty");
            }
        }

        function showToast(msg) {
            var x = document.getElementById("toast");
            x.innerText = msg;
            x.className = "show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        // Socket & Resize
        term.onData(data => socket.emit('input', data));
        socket.on('output', data => term.write(data));

        window.addEventListener('resize', () => {
            fitAddon.fit();
            socket.emit('resize', { cols: term.cols, rows: term.rows });
        });
    </script>
</body>
</html>
